- name: Update Simpliiexchange .NET API (no Nginx changes)
  hosts: web
  become: true
  gather_facts: true

  vars:
    repo_url: "git@github.com:simpliiexchange/simpliiexchange.git"
    repo_root_test: "/var/www/simpliiexchange-api-test"
    repo_root_prod: "/var/www/simpliiexchange-api-prod"
    publish_subdir: "publish"
    service_base_name: "simpliiexchange-api"
    deploy_user: "ansible"
    api_solution_file: "Simpliiexchange.sln"
    api_project_path: "Simpliiexchange/Simpliiexchange.csproj"
    target_env: "test"  # override with -e "target_env=prod"
    repo_branch_test: "dev"
    repo_branch_prod: "main"
    ssh_key_file: "/root/.ssh/id_rsa_backend"

  pre_tasks:
    - name: Fail if target_env is invalid
      ansible.builtin.fail:
        msg: "target_env must be 'test' or 'prod'"
      when: target_env not in ['test', 'prod']

    - name: Set base env-specific variables
      ansible.builtin.set_fact:
        repo_root: "{{ repo_root_test if target_env == 'test' else repo_root_prod }}"
        service_name: "{{ service_base_name }}-{{ target_env }}"
        env_file_path: "{{ (repo_root_test if target_env == 'test' else repo_root_prod) }}/.env"

    - name: Compute publish_dir from repo_root
      ansible.builtin.set_fact:
        publish_dir: "{{ repo_root }}/{{ publish_subdir }}"

  tasks:
    - name: Ensure .ssh directory exists for deploy_user
      ansible.builtin.file:
        path: "/home/{{ deploy_user }}/.ssh"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0700"

    - name: Copy SSH key to deploy_user for GitHub access
      ansible.builtin.copy:
        src: "{{ ssh_key_file }}"
        dest: "/home/{{ deploy_user }}/.ssh/{{ ssh_key_file | basename }}"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0600"
        remote_src: yes

    - name: Ensure repo_root exists
      ansible.builtin.file:
        path: "{{ repo_root }}"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0755"

    - name: Update API repo for this env
      become_user: "{{ deploy_user }}"
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_root }}"
        version: "{{ repo_branch_test if target_env == 'test' else repo_branch_prod }}"
        accept_hostkey: yes
        update: yes
        force: yes
        key_file: "/home/{{ deploy_user }}/.ssh/{{ ssh_key_file | basename }}"

    - name: Restore .NET dependencies
      become_user: "{{ deploy_user }}"
      ansible.builtin.command: dotnet restore {{ api_solution_file }}
      args:
        chdir: "{{ repo_root }}"

    - name: Publish .NET API (Release)
      become_user: "{{ deploy_user }}"
      ansible.builtin.command: >
        dotnet publish {{ api_project_path }} -c Release -o "{{ publish_dir }}"
      args:
        chdir: "{{ repo_root }}"

    - name: Reload systemd units (in case service file changed)
      ansible.builtin.command: systemctl daemon-reload

    - name: Restart .NET API service
      ansible.builtin.systemd:
        name: "{{ service_name }}"
        state: restarted
